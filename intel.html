<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Token Intel - Chillz</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a0f; color: #e0e0e0; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; }

/* Search bar */
.search-bar {
    padding: 16px 24px;
    display: flex;
    gap: 10px;
    align-items: center;
    border-bottom: 1px solid #1e1e2e;
}
.search-bar input {
    flex: 1;
    background: #12121a;
    border: 1px solid #2a2a3e;
    color: #e0e0e0;
    padding: 10px 14px;
    border-radius: 8px;
    font-family: inherit;
    font-size: 13px;
}
.search-bar input:focus { outline: none; border-color: #7dd3fc; }
.search-bar button {
    background: #7dd3fc22;
    border: 1px solid #7dd3fc44;
    color: #7dd3fc;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
}
.search-bar button:hover { background: #7dd3fc33; }
.search-bar button:disabled { opacity: 0.5; cursor: not-allowed; }

/* Sections */
.section {
    padding: 16px 24px;
    border-bottom: 1px solid #1e1e2e;
}
.section-title {
    font-size: 14px;
    font-weight: 700;
    color: #7dd3fc;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Token overview card */
.token-header {
    display: flex;
    gap: 16px;
    align-items: flex-start;
}
.token-img {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #1a1a2e;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 700;
    color: #7dd3fc;
    flex-shrink: 0;
    overflow: hidden;
}
.token-img img { width: 100%; height: 100%; object-fit: cover; }
.token-main { flex: 1; }
.token-name-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 4px;
}
.token-name-row .name { font-size: 18px; font-weight: 700; }
.token-name-row .symbol { font-size: 14px; color: #888; }
.token-name-row .program-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: #8b5cf622;
    color: #8b5cf6;
    border: 1px solid #8b5cf633;
}
.token-desc {
    font-size: 12px;
    color: #666;
    margin-bottom: 8px;
    max-width: 600px;
    line-height: 1.4;
}
.token-stats {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 10px;
}
.stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.stat .label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
.stat .value { font-size: 14px; font-weight: 600; }

.price-change { font-size: 12px; font-weight: 600; }

.links-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}
.links-row a {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 6px;
    text-decoration: none;
    transition: all 0.15s;
}
.link-dex { background: #3b82f622; color: #3b82f6; }
.link-dex:hover { background: #3b82f633; }
.link-solscan { background: #8b5cf622; color: #8b5cf6; }
.link-solscan:hover { background: #8b5cf633; }
.link-birdeye { background: #22c55e22; color: #22c55e; }
.link-birdeye:hover { background: #22c55e33; }
.link-gmgn { background: #f59e0b22; color: #f59e0b; }
.link-gmgn:hover { background: #f59e0b33; }
.link-pump { background: #ef444422; color: #ef4444; }
.link-pump:hover { background: #ef444433; }

/* Risk card */
.risk-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}
.risk-score {
    font-size: 28px;
    font-weight: 700;
    min-width: 60px;
}
.risk-badge {
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
}
.risk-good { background: #22c55e22; color: #22c55e; border: 1px solid #22c55e33; }
.risk-warn { background: #f59e0b22; color: #f59e0b; border: 1px solid #f59e0b33; }
.risk-danger { background: #ef444422; color: #ef4444; border: 1px solid #ef444433; }

.risk-flags {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
}
.risk-flag {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 6px;
    background: #1a1a2e;
}
.risk-flag .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}
.risk-flag .flag-name { flex: 1; color: #ccc; }
.risk-flag .flag-level { font-size: 11px; font-weight: 600; }

.lp-bar-wrap {
    margin-top: 8px;
}
.lp-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #888;
    margin-bottom: 4px;
}
.lp-bar {
    height: 6px;
    background: #1e1e2e;
    border-radius: 3px;
    overflow: hidden;
}
.lp-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: #22c55e;
    transition: width 0.3s;
}
.creator-row {
    margin-top: 10px;
    font-size: 12px;
    color: #888;
}
.creator-row a { color: #7dd3fc; text-decoration: none; }
.creator-row a:hover { text-decoration: underline; }

/* Holders table */
table {
    width: 100%;
    border-collapse: collapse;
}
th {
    text-align: left;
    padding: 8px 10px;
    color: #555;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #1e1e2e;
}
td {
    padding: 8px 10px;
    border-bottom: 1px solid #0f0f18;
    font-size: 12px;
}
tr:hover { background: #ffffff05; }
td a { color: #7dd3fc; text-decoration: none; }
td a:hover { text-decoration: underline; }

.insider-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    background: #ef444422;
    color: #ef4444;
    border: 1px solid #ef444433;
}
.holder-pct {
    font-weight: 600;
}
.holder-bar {
    display: inline-block;
    height: 4px;
    border-radius: 2px;
    background: #7dd3fc;
    margin-left: 8px;
    vertical-align: middle;
}
.top10-summary {
    margin-top: 10px;
    font-size: 12px;
    color: #888;
    padding: 8px 10px;
    background: #1a1a2e;
    border-radius: 6px;
}

/* Social section */
.social-links {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}
.social-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.15s;
    border: 1px solid;
}
.social-twitter { background: #1d9bf022; color: #1d9bf0; border-color: #1d9bf033; }
.social-twitter:hover { background: #1d9bf033; }
.social-website { background: #7dd3fc22; color: #7dd3fc; border-color: #7dd3fc33; }
.social-website:hover { background: #7dd3fc33; }
.social-telegram { background: #0088cc22; color: #0088cc; border-color: #0088cc33; }
.social-telegram:hover { background: #0088cc33; }
.social-discord { background: #5865f222; color: #5865f2; border-color: #5865f233; }
.social-discord:hover { background: #5865f233; }

.search-subtitle {
    font-size: 11px;
    color: #555;
    margin-bottom: 8px;
}
.twitter-searches {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.twitter-search-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 11px;
    background: #1a1a2e;
    color: #ccc;
    border: 1px solid #2a2a3e;
    transition: all 0.15s;
}
.twitter-search-btn:hover { border-color: #1d9bf0; color: #1d9bf0; }

/* Bundle detection */
.btn {
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-family: inherit;
    border: 1px solid;
    transition: all 0.15s;
}
.btn-primary { background: #7dd3fc22; border-color: #7dd3fc44; color: #7dd3fc; }
.btn-primary:hover { background: #7dd3fc33; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.early-summary {
    display: flex;
    gap: 12px;
    margin: 12px 0;
    flex-wrap: wrap;
}
.early-stat {
    background: #1a1a2e;
    border: 1px solid #2a2a3e;
    padding: 8px 16px;
    border-radius: 8px;
    text-align: center;
}
.early-stat .num { font-size: 20px; font-weight: 700; color: #7dd3fc; }
.early-stat .num.red { color: #ef4444; }
.early-stat .num.yellow { color: #f59e0b; }
.early-stat .num.green { color: #22c55e; }
.early-stat .label { font-size: 11px; color: #666; margin-top: 2px; }

.bundle-alert {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    background: #ef444422;
    color: #ef4444;
    border: 1px solid #ef444433;
}
.sniper-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    background: #f59e0b22;
    color: #f59e0b;
    border: 1px solid #f59e0b33;
}
.creator-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    background: #8b5cf622;
    color: #8b5cf6;
    border: 1px solid #8b5cf633;
}

.slot-group { background: #ef44440a; }
.slot-group td { border-bottom-color: #ef444422; }

.progress-text {
    font-size: 11px;
    color: #555;
    margin-top: 8px;
}

/* Loading states */
.loading-placeholder {
    padding: 20px;
    text-align: center;
    color: #444;
    font-size: 12px;
}
.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #333;
    border-top-color: #7dd3fc;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
    text-align: center;
    padding: 60px 24px;
    color: #444;
}
.empty-state h2 { font-size: 16px; margin-bottom: 8px; color: #555; }

.green { color: #22c55e; }
.red { color: #ef4444; }
.yellow { color: #f59e0b; }

/* Twitter Intel */
.twitter-intel-section {
    margin-top: 14px;
}
.twitter-intel-header {
    font-size: 12px;
    font-weight: 600;
    color: #1d9bf0;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.tweet-card {
    background: #12121a;
    border: 1px solid #1e1e2e;
    border-radius: 10px;
    padding: 12px 14px;
    margin-bottom: 8px;
    transition: border-color 0.15s;
    cursor: pointer;
    text-decoration: none;
    display: block;
    color: inherit;
}
.tweet-card:hover { border-color: #1d9bf044; }
.tweet-author {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}
.tweet-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #1a1a2e;
    flex-shrink: 0;
    object-fit: cover;
}
.tweet-author-info { flex: 1; min-width: 0; }
.tweet-author-name {
    font-size: 12px;
    font-weight: 600;
    color: #e0e0e0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.tweet-author-handle {
    font-size: 11px;
    color: #555;
}
.tweet-author-followers {
    font-size: 10px;
    color: #444;
    white-space: nowrap;
}
.tweet-text {
    font-size: 12px;
    color: #ccc;
    line-height: 1.5;
    margin-bottom: 8px;
    word-break: break-word;
}
.tweet-metrics {
    display: flex;
    gap: 16px;
    font-size: 11px;
    color: #555;
}
.tweet-metric {
    display: flex;
    align-items: center;
    gap: 4px;
}
.tweet-metric .heart { color: #ef4444; }
.tweet-metric .rt { color: #22c55e; }
.tweet-metric .reply { color: #1d9bf0; }
.tweet-time {
    font-size: 10px;
    color: #444;
    margin-left: auto;
}
.accounts-grid {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
}
.account-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 8px;
    background: #12121a;
    border: 1px solid #1e1e2e;
    text-decoration: none;
    color: inherit;
    transition: border-color 0.15s;
    max-width: 220px;
}
.account-chip:hover { border-color: #1d9bf044; }
.account-chip img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    flex-shrink: 0;
    object-fit: cover;
}
.account-chip-info { min-width: 0; }
.account-chip-name {
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.account-chip-meta {
    font-size: 10px;
    color: #555;
}
.twitter-fallback-note {
    font-size: 11px;
    color: #555;
    margin-top: 6px;
    font-style: italic;
}
</style>
<link rel="stylesheet" href="shared.css">
</head>
<body>

<div class="search-bar">
    <input type="text" id="tokenInput" placeholder="Paste token contract address..." spellcheck="false">
    <button id="analyzeBtn" onclick="analyze()">Analyze</button>
</div>

<!-- Section 2: Token Overview -->
<div class="section" id="overviewSection" style="display:none;">
    <div id="overviewContent"></div>
</div>

<!-- Section 3: Risk Analysis -->
<div class="section" id="riskSection" style="display:none;">
    <div class="section-title">Risk Analysis</div>
    <div id="riskContent"><div class="loading-placeholder"><span class="spinner"></span> Loading risk data...</div></div>
</div>

<!-- Section 4: Top Holders -->
<div class="section" id="holdersSection" style="display:none;">
    <div class="section-title">Top Holders</div>
    <div id="holdersContent"><div class="loading-placeholder"><span class="spinner"></span> Loading holders...</div></div>
</div>

<!-- Section 5: Social & Twitter Discovery -->
<div class="section" id="socialSection" style="display:none;">
    <div class="section-title">Social & Twitter Discovery</div>
    <div id="socialContent"></div>
</div>

<!-- Section 6: Early Buyers & Bundle Detection -->
<div class="section" id="earlySection" style="display:none;">
    <div class="section-title">Early Buyers & Bundle Detection</div>
    <div id="earlyContent">
        <button class="btn btn-primary" id="earlyBtn" onclick="analyzeEarly()">Analyze Early Transactions</button>
        <div style="font-size:11px;color:#555;margin-top:6px;">Uses Helius credits. Fetches first ~100 transactions of the token.</div>
    </div>
</div>

<div class="empty-state" id="emptyState">
    <h2>Token Intel</h2>
    <p>Paste a token contract address to get comprehensive intelligence: price, risk, holders, socials, and bundle detection.</p>
</div>

<script src="shared.js"></script>
<script>
// --- State ---
let currentMint = '';
let tokenData = {}; // merged data from all sources
let apiKey = '';

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function shortAddr(a) { return a ? a.slice(0, 6) + '...' + a.slice(-4) : ''; }

function formatPrice(n) {
    if (!n || n === 0) return '$0';
    if (n >= 1) return '$' + n.toLocaleString('en', { maximumFractionDigits: 2 });
    // Small numbers: show significant digits
    const s = n.toFixed(20);
    const match = s.match(/^0\.(0*)/);
    const zeros = match ? match[1].length : 0;
    if (zeros > 3) return '$0.0{' + zeros + '}' + s.slice(2 + zeros, 2 + zeros + 4);
    return '$' + n.toFixed(Math.max(2, zeros + 4));
}

function formatMcap(n) {
    if (!n) return '--';
    if (n >= 1e9) return '$' + (n / 1e9).toFixed(2) + 'B';
    if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
    return '$' + n.toFixed(0);
}

function formatAge(ts) {
    if (!ts) return '--';
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return mins + 'm';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h';
    const days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd';
    const months = Math.floor(days / 30);
    if (months < 12) return months + 'mo';
    return Math.floor(months / 12) + 'y';
}

function formatAmount(n) {
    if (!n) return '0';
    if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return n.toFixed(2);
}

// --- API calls ---

async function fetchDexScreener(mint) {
    try {
        const resp = await fetch('https://api.dexscreener.com/latest/dex/tokens/' + mint);
        if (!resp.ok) return null;
        const data = await resp.json();
        if (!data.pairs || !data.pairs.length) return null;
        // Pick the pair with highest liquidity
        const pairs = data.pairs.filter(p => p.chainId === 'solana');
        pairs.sort((a, b) => (b.liquidity?.usd || 0) - (a.liquidity?.usd || 0));
        return pairs[0] || data.pairs[0];
    } catch(e) { return null; }
}

async function fetchRugcheckSummary(mint) {
    try {
        const resp = await fetch('https://api.rugcheck.xyz/v1/tokens/' + mint + '/report/summary');
        if (!resp.ok) return null;
        return resp.json();
    } catch(e) { return null; }
}

async function fetchRugcheckFull(mint) {
    try {
        const resp = await fetch('https://api.rugcheck.xyz/v1/tokens/' + mint + '/report');
        if (!resp.ok) return null;
        return resp.json();
    } catch(e) { return null; }
}

async function fetchHeliusAsset(mint) {
    apiKey = getApiKey();
    if (!apiKey) return null;
    try {
        const resp = await fetch('https://mainnet.helius-rpc.com/?api-key=' + apiKey, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                jsonrpc: '2.0', id: 1,
                method: 'getAsset',
                params: { id: mint }
            })
        });
        const data = await resp.json();
        return data.result || null;
    } catch(e) { return null; }
}

// --- Render functions ---

function renderOverview(dex, asset) {
    const el = document.getElementById('overviewContent');
    if (!dex) {
        el.innerHTML = '<div class="loading-placeholder">No DexScreener data found for this token.</div>';
        return;
    }

    const info = dex.info || {};
    const bt = dex.baseToken || {};
    const name = bt.name || (asset && asset.content && asset.content.metadata ? asset.content.metadata.name : '') || 'Unknown';
    const symbol = bt.symbol || (asset && asset.content && asset.content.metadata ? asset.content.metadata.symbol : '') || '???';
    const img = (info.imageUrl) || (asset && asset.content && asset.content.links && asset.content.links.image) || '';
    const desc = (asset && asset.content && asset.content.metadata ? asset.content.metadata.description : '') || '';
    const price = parseFloat(dex.priceUsd) || 0;
    const mcap = dex.marketCap || dex.fdv || 0;
    const fdv = dex.fdv || 0;
    const vol24 = dex.volume ? dex.volume.h24 : 0;
    const liq = dex.liquidity ? dex.liquidity.usd : 0;
    const pairCreated = dex.pairCreatedAt || 0;
    const priceChange1h = dex.priceChange ? dex.priceChange.h1 : null;
    const priceChange24h = dex.priceChange ? dex.priceChange.h24 : null;

    // Detect token program
    const isToken2022 = asset && asset.interface === 'FungibleAsset' && asset.token_info && asset.token_info.token_program === 'TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb';
    const programBadge = isToken2022 ? '<span class="program-badge">Token-2022</span>' : '<span class="program-badge" style="background:#22c55e22;color:#22c55e;border-color:#22c55e33;">SPL</span>';

    // Detect pump.fun (pair URL or dex info)
    const isPump = dex.url && dex.url.includes('pump.fun') || (dex.dexId && dex.dexId.includes('pump'));

    let html = '<div class="token-header">';
    html += '<div class="token-img">' + (img ? '<img src="' + img + '" onerror="this.parentElement.textContent=\'' + symbol.charAt(0).toUpperCase() + '\'">' : symbol.charAt(0).toUpperCase()) + '</div>';
    html += '<div class="token-main">';
    html += '<div class="token-name-row"><span class="name">' + name + '</span><span class="symbol">$' + symbol + '</span>' + programBadge + '</div>';
    if (desc) html += '<div class="token-desc">' + desc.slice(0, 200) + (desc.length > 200 ? '...' : '') + '</div>';

    html += '<div class="token-stats">';
    html += '<div class="stat"><div class="label">Price</div><div class="value">' + formatPrice(price) + '</div></div>';
    html += '<div class="stat"><div class="label">Market Cap</div><div class="value">' + formatMcap(mcap) + '</div></div>';
    html += '<div class="stat"><div class="label">FDV</div><div class="value">' + formatMcap(fdv) + '</div></div>';
    html += '<div class="stat"><div class="label">24h Vol</div><div class="value">' + formatMcap(vol24) + '</div></div>';
    html += '<div class="stat"><div class="label">Liquidity</div><div class="value">' + formatMcap(liq) + '</div></div>';
    html += '<div class="stat"><div class="label">Age</div><div class="value">' + formatAge(pairCreated) + '</div></div>';

    if (priceChange1h !== null) {
        const c1 = priceChange1h >= 0 ? 'green' : 'red';
        html += '<div class="stat"><div class="label">1h</div><div class="value price-change ' + c1 + '">' + (priceChange1h >= 0 ? '+' : '') + priceChange1h.toFixed(1) + '%</div></div>';
    }
    if (priceChange24h !== null) {
        const c24 = priceChange24h >= 0 ? 'green' : 'red';
        html += '<div class="stat"><div class="label">24h</div><div class="value price-change ' + c24 + '">' + (priceChange24h >= 0 ? '+' : '') + priceChange24h.toFixed(1) + '%</div></div>';
    }
    html += '</div>'; // stats

    html += '<div class="links-row">';
    html += '<a href="https://dexscreener.com/solana/' + currentMint + '" target="_blank" class="link-dex">DexScreener</a>';
    html += '<a href="https://solscan.io/token/' + currentMint + '" target="_blank" class="link-solscan">Solscan</a>';
    html += '<a href="https://birdeye.so/token/' + currentMint + '?chain=solana" target="_blank" class="link-birdeye">Birdeye</a>';
    html += '<a href="https://gmgn.ai/sol/token/' + currentMint + '" target="_blank" class="link-gmgn">GMGN</a>';
    if (isPump) {
        html += '<a href="https://pump.fun/' + currentMint + '" target="_blank" class="link-pump">Pump.fun</a>';
    }
    html += '</div>'; // links

    html += '</div></div>'; // token-main, token-header
    el.innerHTML = html;
}

function renderRisk(summary, full) {
    const el = document.getElementById('riskContent');
    if (!summary && !full) {
        el.innerHTML = '<div class="loading-placeholder">No risk data available from Rugcheck.</div>';
        return;
    }

    const score = summary ? summary.score : (full ? full.score : null);
    const risks = full ? (full.risks || []) : (summary ? (summary.risks || []) : []);

    // Determine risk level
    let riskLevel, riskClass;
    if (score === null || score === undefined) {
        riskLevel = 'Unknown'; riskClass = 'risk-warn';
    } else if (score >= 700) {
        riskLevel = 'Good'; riskClass = 'risk-good';
    } else if (score >= 400) {
        riskLevel = 'Warning'; riskClass = 'risk-warn';
    } else {
        riskLevel = 'Danger'; riskClass = 'risk-danger';
    }

    let html = '<div class="risk-header">';
    html += '<div class="risk-score" style="color:' + (riskClass === 'risk-good' ? '#22c55e' : riskClass === 'risk-warn' ? '#f59e0b' : '#ef4444') + '">' + (score !== null && score !== undefined ? score : '?') + '</div>';
    html += '<span class="risk-badge ' + riskClass + '">' + riskLevel + '</span>';
    html += '</div>';

    if (risks.length > 0) {
        html += '<div class="risk-flags">';
        for (const r of risks) {
            const name = r.name || r.description || 'Unknown risk';
            const level = r.level || r.score || '';
            let dotColor = '#f59e0b';
            let levelColor = '#f59e0b';
            if (level === 'danger' || level === 'critical' || level === 'high') { dotColor = '#ef4444'; levelColor = '#ef4444'; }
            else if (level === 'warn' || level === 'medium') { dotColor = '#f59e0b'; levelColor = '#f59e0b'; }
            else if (level === 'info' || level === 'low') { dotColor = '#22c55e'; levelColor = '#22c55e'; }
            html += '<div class="risk-flag"><div class="dot" style="background:' + dotColor + '"></div><span class="flag-name">' + name + '</span>';
            if (r.description && r.description !== name) html += '<span style="font-size:10px;color:#555;margin-left:8px;">' + r.description.slice(0, 80) + '</span>';
            html += '<span class="flag-level" style="color:' + levelColor + '">' + level + '</span></div>';
        }
        html += '</div>';
    }

    // LP locked %
    if (full && full.markets && full.markets.length > 0) {
        const market = full.markets[0];
        const lpLockedPct = market.lp ? (market.lp.lpLockedPct || 0) : 0;
        html += '<div class="lp-bar-wrap">';
        html += '<div class="lp-bar-label"><span>LP Locked</span><span>' + lpLockedPct.toFixed(1) + '%</span></div>';
        html += '<div class="lp-bar"><div class="lp-bar-fill" style="width:' + Math.min(100, lpLockedPct) + '%;' + (lpLockedPct < 50 ? 'background:#f59e0b;' : '') + '"></div></div>';
        html += '</div>';
    }

    // Creator
    if (full && full.creator) {
        html += '<div class="creator-row">Creator: <a href="https://solscan.io/account/' + full.creator + '" target="_blank">' + shortAddr(full.creator) + '</a></div>';
    }

    el.innerHTML = html;
}

function renderHolders(full) {
    const el = document.getElementById('holdersContent');
    if (!full || !full.topHolders || !full.topHolders.length) {
        el.innerHTML = '<div class="loading-placeholder">No holder data available.</div>';
        return;
    }

    const holders = full.topHolders.slice(0, 10);
    const totalPct = holders.reduce((a, h) => a + (h.pct || 0), 0);

    let html = '<table><thead><tr>';
    html += '<th>#</th><th>Address</th><th>% Held</th><th>Amount</th><th>Type</th>';
    html += '</tr></thead><tbody>';

    holders.forEach((h, i) => {
        const pct = (h.pct || 0);
        const barWidth = Math.min(100, pct * 2); // scale for visual
        html += '<tr>';
        html += '<td style="color:#555;">' + (i + 1) + '</td>';
        html += '<td><a href="https://solscan.io/account/' + h.address + '" target="_blank">' + shortAddr(h.address) + '</a></td>';
        html += '<td><span class="holder-pct">' + pct.toFixed(2) + '%</span><span class="holder-bar" style="width:' + barWidth + 'px;"></span></td>';
        html += '<td>' + formatAmount(h.uiAmount || h.amount || 0) + '</td>';
        html += '<td>';
        if (h.insider) html += '<span class="insider-badge">Insider</span> ';
        if (h.owner === (full.creator || '')) html += '<span class="creator-badge">Creator</span> ';
        html += '</td></tr>';
    });

    html += '</tbody></table>';
    html += '<div class="top10-summary">Top 10 hold <strong>' + totalPct.toFixed(2) + '%</strong> of supply</div>';

    el.innerHTML = html;
}

const WORKER_URL = 'https://chillzmonitor.zinabiadnan.workers.dev';

function renderSocial(dex) {
    const el = document.getElementById('socialContent');
    const info = dex ? (dex.info || {}) : {};
    const socials = info.socials || [];
    const websites = info.websites || [];
    const bt = dex ? (dex.baseToken || {}) : {};
    const symbol = bt.symbol || '???';
    const name = bt.name || '';

    let html = '';

    // Official socials
    const hasAnySocial = socials.length > 0 || websites.length > 0;
    if (hasAnySocial) {
        html += '<div class="social-links">';
        for (const s of socials) {
            if (s.type === 'twitter') {
                html += '<a href="' + s.url + '" target="_blank" class="social-btn social-twitter">Twitter</a>';
            }
            if (s.type === 'telegram') {
                html += '<a href="' + s.url + '" target="_blank" class="social-btn social-telegram">Telegram</a>';
            }
            if (s.type === 'discord') {
                html += '<a href="' + s.url + '" target="_blank" class="social-btn social-discord">Discord</a>';
            }
        }
        for (const w of websites) {
            html += '<a href="' + (w.url || w) + '" target="_blank" class="social-btn social-website">Website</a>';
        }
        html += '</div>';
    }

    if (!hasAnySocial) {
        html += '<div style="font-size:12px;color:#f59e0b;margin-bottom:10px;">No official socials linked on DexScreener</div>';
    }

    // Twitter Intel section — auto-populated
    html += '<div class="twitter-intel-section" id="twitterIntel">';
    html += '<div class="twitter-intel-header"><span class="spinner"></span> Scanning Twitter...</div>';
    html += '</div>';

    // Manual search fallback (shown below, always available)
    html += '<div class="search-subtitle" style="margin-top:14px;">Manual Twitter Search</div>';
    html += '<div class="twitter-searches">';
    html += '<a href="https://x.com/search?q=' + encodeURIComponent(currentMint) + '&f=live" target="_blank" class="twitter-search-btn">Search CA</a>';
    html += '<a href="https://x.com/search?q=' + encodeURIComponent('$' + symbol) + '&f=live" target="_blank" class="twitter-search-btn">Search $' + symbol + '</a>';
    if (name) {
        html += '<a href="https://x.com/search?q=' + encodeURIComponent('"' + name + '"') + '&f=live" target="_blank" class="twitter-search-btn">Search "' + name + '"</a>';
    }
    html += '</div>';

    el.innerHTML = html;

    // Fire Twitter intel fetch
    fetchTwitterIntel(currentMint, symbol, name);
}

function formatTweetTime(dateStr) {
    if (!dateStr) return '';
    try {
        const d = new Date(dateStr);
        const diff = Date.now() - d.getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 60) return mins + 'm ago';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        const days = Math.floor(hrs / 24);
        if (days < 30) return days + 'd ago';
        return d.toLocaleDateString('en', { month: 'short', day: 'numeric' });
    } catch { return ''; }
}

function escapeHtml(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function formatFollowers(n) {
    if (!n) return '0';
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
    return String(n);
}

async function fetchTwitterIntel(mint, symbol, name) {
    const el = document.getElementById('twitterIntel');
    if (!el) return;

    try {
        const resp = await fetch(WORKER_URL + '/api/twitter-search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mint, symbol, name }),
        });

        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error || 'Worker returned ' + resp.status);
        }

        const data = await resp.json();
        renderTwitterIntel(el, data);

    } catch (e) {
        el.innerHTML = '<div class="twitter-fallback-note">Twitter auto-scan unavailable: ' + escapeHtml(e.message) + '. Use manual search below.</div>';
    }
}

function renderTwitterIntel(el, data) {
    const { tweets, accounts } = data;
    let html = '';

    // Related Tweets
    html += '<div class="twitter-intel-header">Related Tweets (' + tweets.length + ')</div>';

    if (tweets.length === 0) {
        html += '<div style="font-size:12px;color:#555;margin-bottom:12px;">No tweets found for this token.</div>';
    } else {
        for (const t of tweets) {
            const u = t.user;
            const tweetUrl = 'https://x.com/' + u.screen_name + '/status/' + t.id;
            const text = t.text.length > 300 ? t.text.slice(0, 297) + '...' : t.text;
            const avatarHtml = u.profile_image_url
                ? '<img class="tweet-avatar" src="' + escapeHtml(u.profile_image_url) + '" onerror="this.style.display=\'none\'">'
                : '<div class="tweet-avatar" style="display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#7dd3fc;">' + (u.name ? u.name.charAt(0).toUpperCase() : '?') + '</div>';

            html += '<a class="tweet-card" href="' + tweetUrl + '" target="_blank">';
            html += '<div class="tweet-author">';
            html += avatarHtml;
            html += '<div class="tweet-author-info">';
            html += '<div class="tweet-author-name">' + escapeHtml(u.name) + (u.verified ? ' &#10003;' : '') + '</div>';
            html += '<div class="tweet-author-handle">@' + escapeHtml(u.screen_name) + '</div>';
            html += '</div>';
            html += '<div class="tweet-author-followers">' + formatFollowers(u.followers_count) + ' followers</div>';
            html += '</div>';
            html += '<div class="tweet-text">' + escapeHtml(text) + '</div>';
            html += '<div class="tweet-metrics">';
            html += '<span class="tweet-metric"><span class="heart">&#9829;</span> ' + t.favorite_count + '</span>';
            html += '<span class="tweet-metric"><span class="rt">&#8635;</span> ' + t.retweet_count + '</span>';
            html += '<span class="tweet-metric"><span class="reply">&#8617;</span> ' + (t.reply_count || 0) + '</span>';
            html += '<span class="tweet-time">' + formatTweetTime(t.created_at) + '</span>';
            html += '</div>';
            html += '</a>';
        }
    }

    // Related Accounts
    if (accounts && accounts.length > 0) {
        html += '<div class="twitter-intel-header" style="margin-top:16px;">Related Accounts (' + accounts.length + ')</div>';
        html += '<div class="accounts-grid">';
        for (const a of accounts) {
            const profileUrl = 'https://x.com/' + a.screen_name;
            const avatarHtml = a.profile_image_url
                ? '<img src="' + escapeHtml(a.profile_image_url) + '" onerror="this.style.display=\'none\'">'
                : '';
            html += '<a class="account-chip" href="' + profileUrl + '" target="_blank">';
            html += avatarHtml;
            html += '<div class="account-chip-info">';
            html += '<div class="account-chip-name">@' + escapeHtml(a.screen_name) + '</div>';
            html += '<div class="account-chip-meta">' + formatFollowers(a.followers_count) + ' followers &middot; ' + a.tweet_count_in_results + ' tweet' + (a.tweet_count_in_results !== 1 ? 's' : '') + '</div>';
            html += '</div></a>';
        }
        html += '</div>';
    }

    el.innerHTML = html;
}

// --- Early Buyers & Bundle Detection ---
async function analyzeEarly() {
    apiKey = getApiKey();
    if (!apiKey) return;
    if (!currentMint) return;

    const btn = document.getElementById('earlyBtn');
    btn.disabled = true;
    btn.textContent = 'Analyzing...';

    const el = document.getElementById('earlyContent');
    el.innerHTML = '<div class="loading-placeholder"><span class="spinner"></span> Fetching early transactions...</div>';

    try {
        // Fetch first ~100 transactions of the token mint
        let allTxs = [];
        let beforeSig = null;
        const maxPages = 2; // 2 pages * 100 = ~200 txs
        for (let page = 0; page < maxPages; page++) {
            let url = 'https://api-mainnet.helius-rpc.com/v0/addresses/' + currentMint + '/transactions?api-key=' + apiKey + '&limit=100';
            if (beforeSig) url += '&before=' + beforeSig;
            try {
                const resp = await fetch(url);
                if (!resp.ok) break;
                const data = await resp.json();
                if (!data.length) break;
                allTxs = allTxs.concat(data);
                beforeSig = data[data.length - 1].signature;
                if (data.length < 100) break;
            } catch(e) { break; }
            await sleep(150);
        }

        if (!allTxs.length) {
            el.innerHTML = '<div class="loading-placeholder">No transactions found for this token.</div>';
            btn.disabled = false;
            btn.textContent = 'Analyze Early Transactions';
            return;
        }

        // Sort oldest first
        allTxs.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

        // Extract early buyers with slot info
        const buyers = [];
        const seenWallets = new Set();
        const SKIP = new Set(['11111111111111111111111111111111', currentMint]);
        const creatorAddr = tokenData.creator || '';

        for (const tx of allTxs) {
            if (tx.transactionError) continue;
            const fp = tx.feePayer;
            if (!fp || SKIP.has(fp)) continue;
            if (seenWallets.has(fp)) continue;
            seenWallets.add(fp);
            buyers.push({
                wallet: fp,
                slot: tx.slot || 0,
                timestamp: tx.timestamp || 0,
                sig: tx.signature,
                isCreator: fp === creatorAddr
            });
        }

        // Get first slot for sniper detection
        const firstSlot = buyers.length > 0 ? buyers[0].slot : 0;

        // Group by slot for bundle detection
        const slotGroups = {};
        for (const b of buyers) {
            if (!slotGroups[b.slot]) slotGroups[b.slot] = [];
            slotGroups[b.slot].push(b);
        }

        // Identify bundles (multiple buys in same slot)
        const bundleSlots = {};
        for (const [slot, group] of Object.entries(slotGroups)) {
            if (group.length >= 2) bundleSlots[slot] = group.length;
        }

        // Stats
        const totalBuyers = buyers.length;
        const sniperCount = buyers.filter(b => b.slot > 0 && (b.slot - firstSlot) <= 2).length;
        const bundleCount = Object.keys(bundleSlots).length;
        const bundledWallets = Object.values(bundleSlots).reduce((a, n) => a + n, 0);
        const creatorBuy = buyers.find(b => b.isCreator);

        // Render
        let html = '<div class="early-summary">';
        html += '<div class="early-stat"><div class="num">' + totalBuyers + '</div><div class="label">Early Wallets</div></div>';
        html += '<div class="early-stat"><div class="num yellow">' + sniperCount + '</div><div class="label">Snipers (first 3 slots)</div></div>';
        html += '<div class="early-stat"><div class="num' + (bundleCount > 0 ? ' red' : '') + '">' + bundleCount + '</div><div class="label">Bundle Slots</div></div>';
        html += '<div class="early-stat"><div class="num' + (bundledWallets > 0 ? ' red' : '') + '">' + bundledWallets + '</div><div class="label">Bundled Wallets</div></div>';
        if (creatorBuy) {
            html += '<div class="early-stat"><div class="num red">Yes</div><div class="label">Creator Bought</div></div>';
        }
        html += '</div>';

        // Table
        const display = buyers.slice(0, 50);
        html += '<table><thead><tr>';
        html += '<th>#</th><th>Wallet</th><th>Slot</th><th>Time</th><th>Flags</th>';
        html += '</tr></thead><tbody>';

        for (let i = 0; i < display.length; i++) {
            const b = display[i];
            const isBundle = bundleSlots[b.slot];
            const isSniper = b.slot > 0 && (b.slot - firstSlot) <= 2;
            const trClass = isBundle ? ' class="slot-group"' : '';

            html += '<tr' + trClass + '>';
            html += '<td style="color:#555;">' + (i + 1) + '</td>';
            html += '<td><a href="https://solscan.io/account/' + b.wallet + '" target="_blank">' + shortAddr(b.wallet) + '</a></td>';
            html += '<td style="font-size:11px;color:#888;">' + b.slot + '</td>';
            html += '<td style="font-size:11px;color:#666;">' + (b.timestamp ? new Date(b.timestamp * 1000).toLocaleString('en', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }) : '--') + '</td>';
            html += '<td>';
            if (isBundle) html += '<span class="bundle-alert">Bundle (' + bundleSlots[b.slot] + ')</span> ';
            if (isSniper) html += '<span class="sniper-badge">Sniper</span> ';
            if (b.isCreator) html += '<span class="creator-badge">Creator</span> ';
            html += '</td></tr>';
        }

        html += '</tbody></table>';
        if (buyers.length > 50) {
            html += '<div style="text-align:center;padding:12px;color:#555;font-size:11px;">Showing first 50 of ' + buyers.length + ' early wallets</div>';
        }

        el.innerHTML = html;

    } catch(e) {
        el.innerHTML = '<div class="loading-placeholder" style="color:#ef4444;">Error: ' + e.message + '</div>';
    }

    btn.disabled = false;
    btn.textContent = 'Analyze Early Transactions';
}

// --- Main analyze flow ---
async function analyze() {
    const input = document.getElementById('tokenInput').value.trim();
    if (!input || input.length < 32) return alert('Enter a valid token contract address');

    currentMint = input;
    tokenData = {};

    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    btn.textContent = 'Loading...';

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('overviewSection').style.display = 'block';
    document.getElementById('riskSection').style.display = 'block';
    document.getElementById('socialSection').style.display = 'block';
    document.getElementById('holdersSection').style.display = 'block';
    document.getElementById('earlySection').style.display = 'block';

    // Reset sections
    document.getElementById('overviewContent').innerHTML = '<div class="loading-placeholder"><span class="spinner"></span> Loading token data...</div>';
    document.getElementById('riskContent').innerHTML = '<div class="loading-placeholder"><span class="spinner"></span> Loading risk data...</div>';
    document.getElementById('holdersContent').innerHTML = '<div class="loading-placeholder"><span class="spinner"></span> Loading holders...</div>';
    document.getElementById('socialContent').innerHTML = '<div class="loading-placeholder"><span class="spinner"></span> Loading socials...</div>';
    document.getElementById('earlyContent').innerHTML = '<button class="btn btn-primary" id="earlyBtn" onclick="analyzeEarly()">Analyze Early Transactions</button><div style="font-size:11px;color:#555;margin-top:6px;">Uses Helius credits. Fetches first ~100 transactions of the token.</div>';

    // Phase 1: Instant — DexScreener + Rugcheck summary (parallel)
    const [dex, rugSummary] = await Promise.all([
        fetchDexScreener(currentMint),
        fetchRugcheckSummary(currentMint)
    ]);

    renderOverview(dex, null);
    renderRisk(rugSummary, null);
    renderSocial(dex);

    // Phase 2: Background — Rugcheck full + Helius getAsset (parallel)
    const [rugFull, asset] = await Promise.all([
        fetchRugcheckFull(currentMint),
        fetchHeliusAsset(currentMint)
    ]);

    // Store creator for bundle detection
    if (rugFull && rugFull.creator) tokenData.creator = rugFull.creator;

    // Re-render with full data
    renderOverview(dex, asset);
    renderRisk(rugSummary, rugFull);
    renderHolders(rugFull);

    btn.disabled = false;
    btn.textContent = 'Analyze';
}

// Enter key support
document.getElementById('tokenInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') analyze();
});

// URL param support: ?token=MINT
const params = new URLSearchParams(location.search);
if (params.get('token')) {
    document.getElementById('tokenInput').value = params.get('token');
    setTimeout(analyze, 500);
}
</script>
</body>
</html>
