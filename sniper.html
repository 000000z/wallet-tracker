<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claim Sniper - Chillz</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a0f; color: #e0e0e0; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; }

/* Status Dashboard */
.status-panel {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    padding: 16px 24px;
    border-bottom: 1px solid #1e1e2e;
}
.status-card {
    background: #12121a;
    border: 1px solid #1e1e2e;
    border-radius: 8px;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.status-card .label {
    font-size: 10px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}
.status-card .value {
    font-size: 16px;
    font-weight: 700;
    color: #e0e0e0;
}
.status-card .value.running { color: #22c55e; }
.status-card .value.stopped { color: #ef4444; }
.status-card .value.connecting { color: #f59e0b; }
.status-card .value.mono { font-size: 12px; font-weight: 400; cursor: help; }

/* Section cards */
.section {
    margin: 16px 24px;
    background: #12121a;
    border: 1px solid #1e1e2e;
    border-radius: 10px;
    padding: 16px 20px;
}
.section-title {
    font-size: 12px;
    color: #7dd3fc;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 700;
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid #1e1e2e;
}

/* Form rows */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
}
.form-row {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.form-row.full { grid-column: 1 / -1; }
.form-row label {
    font-size: 11px;
    color: #888;
    font-weight: 600;
}
.form-row input, .form-row textarea {
    background: #0d0d14;
    border: 1px solid #2a2a3e;
    color: #e0e0e0;
    padding: 8px 12px;
    border-radius: 6px;
    font-family: inherit;
    font-size: 13px;
}
.form-row input:focus, .form-row textarea:focus { outline: none; border-color: #7dd3fc; }
.form-row textarea { resize: vertical; min-height: 60px; }
.form-row .hint {
    font-size: 10px;
    color: #444;
}

/* Password toggle */
.pw-wrap {
    position: relative;
}
.pw-wrap input { width: 100%; padding-right: 56px; }
.pw-toggle {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    background: #1e1e2e;
    border: none;
    color: #888;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-family: inherit;
}
.pw-toggle:hover { color: #ccc; }

/* Toggle switch */
.toggle-row {
    display: flex;
    align-items: center;
    gap: 10px;
}
.toggle-switch {
    width: 40px;
    height: 22px;
    background: #2a2a3e;
    border-radius: 11px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}
.toggle-switch.on { background: #22c55e44; }
.toggle-switch .toggle-knob {
    width: 16px;
    height: 16px;
    background: #555;
    border-radius: 50%;
    position: absolute;
    top: 3px;
    left: 3px;
    transition: all 0.2s;
}
.toggle-switch.on .toggle-knob {
    left: 21px;
    background: #22c55e;
}
.toggle-label {
    font-size: 12px;
    color: #888;
}

/* Controls */
.controls {
    display: flex;
    gap: 10px;
    padding: 0 24px 16px;
}
.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid transparent;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.15s;
}
.btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}
.btn-start {
    background: #22c55e22;
    border-color: #22c55e44;
    color: #22c55e;
}
.btn-start:hover:not(:disabled) { background: #22c55e33; }
.btn-stop {
    background: #ef444422;
    border-color: #ef444444;
    color: #ef4444;
}
.btn-stop:hover:not(:disabled) { background: #ef444433; }
.btn-clear {
    background: #1e1e2e;
    border-color: #2a2a3e;
    color: #888;
}
.btn-clear:hover:not(:disabled) { background: #2a2a3e; color: #ccc; }
.btn-refresh {
    background: #f59e0b22;
    border-color: #f59e0b44;
    color: #f59e0b;
}
.btn-refresh:hover:not(:disabled) { background: #f59e0b33; }
.btn-save {
    background: #7dd3fc22;
    border-color: #7dd3fc44;
    color: #7dd3fc;
    margin-top: 8px;
}
.btn-save:hover { background: #7dd3fc33; }

/* Bought tokens table */
.bought-section { display: none; }
.bought-section.visible { display: block; }
.bought-table {
    width: 100%;
    border-collapse: collapse;
}
.bought-table th {
    text-align: left;
    font-size: 10px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 10px;
    border-bottom: 1px solid #1e1e2e;
    font-weight: 600;
}
.bought-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #1e1e2e08;
    font-size: 12px;
    color: #ccc;
}
.bought-table tr:hover td { background: #ffffff04; }
.bought-table a {
    color: #7dd3fc;
    text-decoration: none;
}
.bought-table a:hover { text-decoration: underline; }
.badge-dry {
    display: inline-block;
    background: #f59e0b22;
    color: #f59e0b;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
}

/* Event log */
.alert-log {
    max-height: 500px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.log-entry {
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 4px;
    border-left: 3px solid #333;
    background: #0d0d14;
    display: flex;
    gap: 8px;
    line-height: 1.5;
}
.log-entry .log-time {
    color: #444;
    white-space: nowrap;
    flex-shrink: 0;
}
.log-entry .log-msg {
    color: #999;
    word-break: break-all;
}
.log-entry.info { border-left-color: #3b82f6; }
.log-entry.info .log-msg { color: #7dd3fc; }
.log-entry.claim { border-left-color: #f59e0b; }
.log-entry.claim .log-msg { color: #fbbf24; }
.log-entry.buy { border-left-color: #22c55e; }
.log-entry.buy .log-msg { color: #4ade80; }
.log-entry.skip { border-left-color: #555; }
.log-entry.skip .log-msg { color: #777; }
.log-entry.error { border-left-color: #ef4444; }
.log-entry.error .log-msg { color: #f87171; }

/* Scrollbar */
.alert-log::-webkit-scrollbar { width: 6px; }
.alert-log::-webkit-scrollbar-track { background: transparent; }
.alert-log::-webkit-scrollbar-thumb { background: #2a2a3e; border-radius: 3px; }

/* Responsive */
@media (max-width: 900px) {
    .status-panel { grid-template-columns: repeat(3, 1fr); }
    .form-grid { grid-template-columns: 1fr; }
}
</style>
<link rel="stylesheet" href="shared.css">
</head>
<body>

<!-- Status Dashboard -->
<div class="status-panel">
    <div class="status-card">
        <div class="label">Sniper</div>
        <div class="value stopped" id="statusSniper">Stopped</div>
    </div>
    <div class="status-card">
        <div class="label">Wallet</div>
        <div class="value mono" id="statusWallet" title="">--</div>
    </div>
    <div class="status-card">
        <div class="label">ETH Balance</div>
        <div class="value" id="statusBalance">--</div>
    </div>
    <div class="status-card">
        <div class="label">Current Block</div>
        <div class="value" id="statusBlock">--</div>
    </div>
    <div class="status-card">
        <div class="label">Claims Detected</div>
        <div class="value" id="statusClaims">0</div>
    </div>
    <div class="status-card">
        <div class="label">Buys Executed</div>
        <div class="value" id="statusBuys">0</div>
    </div>
</div>

<!-- Configuration -->
<div class="section">
    <div class="section-title">Configuration</div>
    <div class="form-grid">
        <div class="form-row">
            <label>Private Key</label>
            <div class="pw-wrap">
                <input type="password" id="cfgPrivateKey" placeholder="0x...">
                <button class="pw-toggle" onclick="togglePw()">show</button>
            </div>
            <div class="hint">Set via Railway env vars (optional override here)</div>
        </div>
        <div class="form-row">
            <label>RPC URL</label>
            <input type="text" id="cfgRpcUrl" placeholder="https://mainnet.base.org">
        </div>
        <div class="form-row">
            <label>Buy Amount (ETH)</label>
            <input type="number" id="cfgBuyAmount" step="0.001" min="0" placeholder="0.005">
        </div>
        <div class="form-row">
            <label>Slippage %</label>
            <input type="number" id="cfgSlippage" min="1" max="50" placeholder="10">
        </div>
        <div class="form-row">
            <label>Min Claim (wei)</label>
            <input type="text" id="cfgMinClaim" placeholder="1000000000000000">
        </div>
        <div class="form-row">
            <label>Poll Interval (ms)</label>
            <input type="number" id="cfgPollInterval" min="1000" max="30000" step="500" placeholder="3000">
        </div>
        <div class="form-row">
            <label>Max Buys / Token</label>
            <input type="number" id="cfgMaxBuys" min="1" max="10" placeholder="1">
        </div>
        <div class="form-row">
            <label>Dry Run</label>
            <div class="toggle-row">
                <div class="toggle-switch on" id="cfgDryRun" onclick="toggleDryRun()">
                    <div class="toggle-knob"></div>
                </div>
                <span class="toggle-label" id="dryRunLabel">ON — no real transactions</span>
            </div>
        </div>
        <div class="form-row full">
            <label>Watched Tokens (one per line, empty = all)</label>
            <textarea id="cfgWatchedTokens" rows="3" placeholder="0x...&#10;0x..."></textarea>
        </div>
        <div class="form-row full">
            <label>Blacklisted Tokens (one per line)</label>
            <textarea id="cfgBlacklistedTokens" rows="3" placeholder="0x...&#10;0x..."></textarea>
        </div>
    </div>
    <button class="btn btn-save" onclick="saveConfig()">Save Config</button>
</div>

<!-- Controls -->
<div class="controls">
    <button class="btn btn-start" id="btnStart" onclick="startSniper()">Start Sniper</button>
    <button class="btn btn-stop" id="btnStop" onclick="stopSniper()" disabled>Stop Sniper</button>
    <button class="btn btn-clear" onclick="clearLog()">Clear Log</button>
    <button class="btn btn-refresh" onclick="refreshBalance()">Refresh Balance</button>
</div>

<!-- Remove from scanned list -->
<div class="section" style="padding:12px 20px;border-bottom:1px solid #1e1e2e;">
    <div style="display:flex;gap:8px;align-items:center;">
        <input type="text" id="removeScannedInput" placeholder="Paste contract to re-enable scanning..." style="flex:1;background:#1a1a2e;border:1px solid #2a2a3e;color:#e0e0e0;padding:8px 12px;border-radius:6px;font-family:inherit;font-size:13px;">
        <button class="btn btn-clear" onclick="removeScanned()">Remove from scanned</button>
        <span id="removeResult" style="font-size:11px;color:#666;"></span>
    </div>
    <div style="font-size:11px;color:#484f58;margin-top:4px;">Removes a token from the "already processed" list so it can be scanned again on next claim</div>
</div>

<!-- Bought Tokens -->
<div class="section bought-section" id="boughtSection">
    <div class="section-title">Bought Tokens</div>
    <table class="bought-table">
        <thead>
            <tr>
                <th>Token</th>
                <th>Buy #</th>
                <th>Amount In</th>
                <th>Amount Out</th>
                <th>TX</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody id="boughtBody"></tbody>
    </table>
</div>

<!-- Event Log -->
<div class="section">
    <div class="section-title">Event Log</div>
    <div class="alert-log" id="eventLog"></div>
</div>

<script src="shared.js"></script>
<script>
// ─── Server-Backed Sniper Dashboard ─────────────────────────────────────────
// All sniper logic runs on the server. This UI connects via WebSocket for
// live log streaming and REST API for control/config/status.

// ─── DOM refs ───────────────────────────────────────────────────────────────
const $status = document.getElementById('statusSniper');
const $wallet = document.getElementById('statusWallet');
const $balance = document.getElementById('statusBalance');
const $block = document.getElementById('statusBlock');
const $claims = document.getElementById('statusClaims');
const $buys = document.getElementById('statusBuys');
const $log = document.getElementById('eventLog');
const $boughtSection = document.getElementById('boughtSection');
const $boughtBody = document.getElementById('boughtBody');
const $btnStart = document.getElementById('btnStart');
const $btnStop = document.getElementById('btnStop');

// ─── API Helpers ────────────────────────────────────────────────────────────
const API_BASE = location.origin;

async function api(method, path, body) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(API_BASE + path, opts);
    return res.json();
}

// ─── WebSocket Connection ───────────────────────────────────────────────────
let ws = null;
let wsRetryTimer = null;

function connectWS() {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(proto + '//' + location.host + '/ws');

    ws.onopen = () => {
        logEvent('info', 'WebSocket connected to server');
        if (wsRetryTimer) { clearTimeout(wsRetryTimer); wsRetryTimer = null; }
    };

    ws.onmessage = (ev) => {
        try {
            const data = JSON.parse(ev.data);
            logEvent(data.type || 'info', data.msg || '');
        } catch {
            logEvent('info', ev.data);
        }
    };

    ws.onclose = () => {
        logEvent('error', 'WebSocket disconnected — reconnecting in 3s...');
        wsRetryTimer = setTimeout(connectWS, 3000);
    };

    ws.onerror = () => {
        ws.close();
    };
}

// ─── Event Log ──────────────────────────────────────────────────────────────
const MAX_LOG_ENTRIES = 500;

function logEvent(type, msg) {
    const now = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = 'log-entry ' + type;
    entry.innerHTML = '<span class="log-time">' + now + '</span><span class="log-msg">' + escapeHtml(msg) + '</span>';
    $log.insertBefore(entry, $log.firstChild);
    while ($log.children.length > MAX_LOG_ENTRIES) {
        $log.removeChild($log.lastChild);
    }
}

function escapeHtml(s) {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function clearLog() {
    $log.innerHTML = '';
    logEvent('info', 'Log cleared');
}

// ─── Buy History ────────────────────────────────────────────────────────────
let buyHistory = [];

function renderBuyHistory() {
    if (buyHistory.length === 0) {
        $boughtSection.classList.remove('visible');
        return;
    }
    $boughtSection.classList.add('visible');
    $boughtBody.innerHTML = buyHistory.map(b => {
        const shortToken = b.token.slice(0, 6) + '...' + b.token.slice(-4);
        const txCell = b.dryRun
            ? '<span class="badge-dry">dry run</span>'
            : '<a href="https://basescan.org/tx/' + b.txHash + '" target="_blank">' + b.txHash.slice(0, 10) + '...</a>';
        return '<tr>' +
            '<td><a href="https://basescan.org/token/' + b.token + '" target="_blank">' + shortToken + '</a></td>' +
            '<td>' + b.buyCount + '</td>' +
            '<td>' + b.amountIn + ' ETH</td>' +
            '<td>' + b.amountOut + '</td>' +
            '<td>' + txCell + '</td>' +
            '<td>' + new Date(b.time).toLocaleTimeString() + '</td>' +
        '</tr>';
    }).join('');
}

async function loadBuyHistory() {
    try {
        buyHistory = await api('GET', '/api/sniper/history');
        renderBuyHistory();
    } catch (err) {
        logEvent('error', 'Failed to load buy history: ' + err.message);
    }
}

// ─── Config (load from server, save to server) ─────────────────────────────
async function loadConfigToForm() {
    try {
        const c = await api('GET', '/api/sniper/config');
        document.getElementById('cfgPrivateKey').value = '';
        document.getElementById('cfgPrivateKey').placeholder = c.privateKey || '(set via env var)';
        document.getElementById('cfgRpcUrl').value = c.rpcUrl || '';
        document.getElementById('cfgBuyAmount').value = c.buyAmountEth || '';
        document.getElementById('cfgSlippage').value = c.slippagePct || '';
        document.getElementById('cfgMinClaim').value = c.minClaimAmountWei || '';
        document.getElementById('cfgPollInterval').value = c.pollIntervalMs || '';
        document.getElementById('cfgMaxBuys').value = c.maxBuysPerToken || '';
        // Dry run toggle
        const toggle = document.getElementById('cfgDryRun');
        const label = document.getElementById('dryRunLabel');
        if (c.dryRun) {
            toggle.classList.add('on');
            label.textContent = 'ON \u2014 no real transactions';
        } else {
            toggle.classList.remove('on');
            label.textContent = 'OFF \u2014 LIVE trading';
        }
        document.getElementById('cfgWatchedTokens').value = (c.watchedTokens || []).join('\n');
        document.getElementById('cfgBlacklistedTokens').value = (c.blacklistedTokens || []).join('\n');
    } catch (err) {
        logEvent('error', 'Failed to load config from server: ' + err.message);
    }
}

async function saveConfig() {
    const body = {
        rpcUrl: document.getElementById('cfgRpcUrl').value.trim(),
        buyAmountEth: document.getElementById('cfgBuyAmount').value.replace(',', '.'),
        slippagePct: document.getElementById('cfgSlippage').value.replace(',', '.'),
        minClaimAmountWei: document.getElementById('cfgMinClaim').value.trim(),
        pollIntervalMs: document.getElementById('cfgPollInterval').value,
        maxBuysPerToken: document.getElementById('cfgMaxBuys').value,
        dryRun: document.getElementById('cfgDryRun').classList.contains('on'),
        watchedTokens: document.getElementById('cfgWatchedTokens').value.trim(),
        blacklistedTokens: document.getElementById('cfgBlacklistedTokens').value.trim(),
    };
    // Only send private key if the user actually typed one
    const pk = document.getElementById('cfgPrivateKey').value.trim();
    if (pk) body.privateKey = pk;

    try {
        const result = await api('POST', '/api/sniper/config', body);
        if (result.ok) {
            logEvent('info', 'Config saved to server');
        } else {
            logEvent('error', 'Config save failed: ' + (result.error || 'unknown'));
        }
    } catch (err) {
        logEvent('error', 'Config save failed: ' + err.message);
    }
}

function toggleDryRun() {
    const toggle = document.getElementById('cfgDryRun');
    const label = document.getElementById('dryRunLabel');
    toggle.classList.toggle('on');
    if (toggle.classList.contains('on')) {
        label.textContent = 'ON \u2014 no real transactions';
    } else {
        label.textContent = 'OFF \u2014 LIVE trading';
    }
}

function togglePw() {
    const inp = document.getElementById('cfgPrivateKey');
    const btn = inp.nextElementSibling;
    if (inp.type === 'password') {
        inp.type = 'text';
        btn.textContent = 'hide';
    } else {
        inp.type = 'password';
        btn.textContent = 'show';
    }
}

// ─── Remove from scanned list ───────────────────────────────────────────────
async function removeScanned() {
    const input = document.getElementById('removeScannedInput');
    const result = document.getElementById('removeResult');
    const token = input.value.trim();
    if (!token) { result.textContent = 'Paste a contract address'; result.style.color = '#f85149'; return; }
    try {
        const resp = await api('POST', '/api/sniper/scanned/remove', { token });
        if (resp.deleted) {
            result.textContent = 'Removed — will scan again on next claim';
            result.style.color = '#3fb950';
            input.value = '';
        } else {
            result.textContent = 'Not found in scanned list';
            result.style.color = '#f59e0b';
        }
    } catch (err) {
        result.textContent = 'Error: ' + err.message;
        result.style.color = '#f85149';
    }
}

// ─── Start / Stop (server-side) ─────────────────────────────────────────────
async function startSniper() {
    $status.textContent = 'Starting...';
    $status.className = 'value connecting';
    $btnStart.disabled = true;
    logEvent('info', 'Sending start command to server...');

    try {
        const result = await api('POST', '/api/sniper/start');
        if (result.ok) {
            $status.textContent = 'Running';
            $status.className = 'value running';
            $btnStop.disabled = false;
        } else {
            logEvent('error', 'Start failed: ' + (result.error || 'unknown'));
            $status.textContent = 'Stopped';
            $status.className = 'value stopped';
            $btnStart.disabled = false;
        }
    } catch (err) {
        logEvent('error', 'Start failed: ' + err.message);
        $status.textContent = 'Stopped';
        $status.className = 'value stopped';
        $btnStart.disabled = false;
    }
}

async function stopSniper() {
    logEvent('info', 'Sending stop command to server...');
    try {
        await api('POST', '/api/sniper/stop');
        $status.textContent = 'Stopped';
        $status.className = 'value stopped';
        $btnStart.disabled = false;
        $btnStop.disabled = true;
    } catch (err) {
        logEvent('error', 'Stop failed: ' + err.message);
    }
}

// ─── Status Polling ─────────────────────────────────────────────────────────
async function pollStatus() {
    try {
        const s = await api('GET', '/api/sniper/status');
        // Update status indicator
        if (s.running) {
            $status.textContent = 'Running';
            $status.className = 'value running';
            $btnStart.disabled = true;
            $btnStop.disabled = false;
        } else {
            $status.textContent = 'Stopped';
            $status.className = 'value stopped';
            $btnStart.disabled = false;
            $btnStop.disabled = true;
        }
        // Update stats
        if (s.wallet) {
            $wallet.textContent = s.wallet.slice(0, 6) + '...' + s.wallet.slice(-4);
            $wallet.title = s.wallet;
        }
        if (s.balance) $balance.textContent = parseFloat(s.balance).toFixed(4) + ' ETH';
        if (s.block) $block.textContent = s.block.toLocaleString();
        $claims.textContent = s.claimsDetected || 0;
        $buys.textContent = s.buysExecuted || 0;
    } catch {
        // Server unreachable — will retry
    }
}

async function refreshBalance() {
    logEvent('info', 'Refreshing status...');
    await pollStatus();
    await loadBuyHistory();
    logEvent('info', 'Status refreshed');
}

// ─── Init ───────────────────────────────────────────────────────────────────
connectWS();
loadConfigToForm();
loadBuyHistory();
pollStatus();
setInterval(pollStatus, 3000);
</script>
</body>
</html>
